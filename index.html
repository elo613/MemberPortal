<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Member Portal</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root { --primary: #3ecf8e; --error: #ff4d4d; --bg: #f4f7f6; }
        body { font-family: -apple-system, system-ui, sans-serif; background: var(--bg); display: flex; justify-content: center; align-items: center; min-height: 100vh; margin: 0; }
        .card { background: white; padding: 2.5rem; border-radius: 16px; box-shadow: 0 10px 25px rgba(0,0,0,0.05); width: 100%; max-width: 400px; text-align: center; }
        h2 { margin-top: 0; color: #333; }
        input { width: 100%; padding: 12px; margin: 8px 0; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; font-size: 16px; }
        button { width: 100%; padding: 12px; background: var(--primary); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 16px; margin-top: 10px; transition: opacity 0.2s; }
        button:hover { opacity: 0.9; }
        .secondary-btn { background: none; color: #666; text-decoration: underline; font-size: 14px; margin-top: 15px; border: none; cursor: pointer; }
        .hidden { display: none; }
        #user-code { font-size: 24px; font-weight: bold; color: var(--primary); letter-spacing: 2px; margin: 20px 0; padding: 10px; background: #eefaf5; border-radius: 8px; }
        .pdf-box { border: 2px dashed var(--primary); padding: 20px; border-radius: 12px; margin: 20px 0; }
        #loading { color: var(--primary); font-weight: bold; }
    </style>
</head>
<body>

    <div class="card">
        <div id="loading">Loading...</div>

        <div id="auth-ui" class="hidden">
            <h2 id="auth-title">Login</h2>
            <input type="email" id="email" placeholder="Email Address">
            <input type="password" id="password" placeholder="Password">
            <button id="main-btn" onclick="handleAuth()">Login</button>
            
            <button class="secondary-btn" id="toggle-btn" onclick="toggleAuth()">Need an account? Sign Up</button>
            <br>
            <button class="secondary-btn" onclick="forgotPassword()">Forgot Password?</button>
        </div>

        <div id="dashboard" class="hidden">
            <h2>Welcome Back</h2>
            <p>Your Unique 14-Digit Code:</p>
            <div id="user-code">Generating...</div>
            
            <div class="pdf-box">
                <p>Access Secure Document:</p>
                <a id="pdf-link" href="#" target="_blank" style="text-decoration: none;">
                    <button style="background: #333;">ðŸ“„ View Shared PDF</button>
                </a>
                <p style="font-size: 12px; color: #888; margin-top: 10px;">Link expires in 60 seconds</p>
            </div>

            <button onclick="signOut()" style="background: var(--error);">Sign Out</button>
        </div>
    </div>

    <script>
        // --- CONFIGURATION ---
        const SUPABASE_URL = 'https://YOUR_PROJECT_ID.supabase.co';
        const SUPABASE_KEY = 'YOUR_ANON_KEY';
        const PDF_FILENAME = 'your-file-name.pdf'; // Must match file in Supabase storage
        
        const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        let isSignUp = false;

        // --- AUTH LOGIC ---
        function toggleAuth() {
            isSignUp = !isSignUp;
            document.getElementById('auth-title').innerText = isSignUp ? 'Create Account' : 'Login';
            document.getElementById('main-btn').innerText = isSignUp ? 'Sign Up' : 'Login';
            document.getElementById('toggle-btn').innerText = isSignUp ? 'Have an account? Login' : 'Need an account? Sign Up';
        }

        async function handleAuth() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            if(!email || !password) return alert("Please fill in all fields");

            if (isSignUp) {
                const { error } = await supabase.auth.signUp({ email, password });
                if (error) alert(error.message);
                else alert("Success! Check your email for a confirmation link.");
            } else {
                const { error } = await supabase.auth.signInWithPassword({ email, password });
                if (error) alert(error.message);
            }
        }

        async function forgotPassword() {
            const email = document.getElementById('email').value;
            if (!email) return alert("Please enter your email address first.");
            const { error } = await supabase.auth.resetPasswordForEmail(email);
            if (error) alert(error.message);
            else alert("Password reset link sent to your email!");
        }

        async function signOut() {
            await supabase.auth.signOut();
        }

        // --- UI & DATA LOGIC ---
        async function refreshUI() {
            document.getElementById('loading').classList.remove('hidden');
            const { data: { user } } = await supabase.auth.getUser();

            if (user) {
                document.getElementById('auth-ui').classList.add('hidden');
                document.getElementById('dashboard').classList.remove('hidden');
                
                // 1. Fetch Unique Code
                const { data: profile } = await supabase.from('profiles').select('unique_code').eq('id', user.id).single();
                if (profile) document.getElementById('user-code').innerText = profile.unique_code;

                // 2. Fetch Secure PDF Link (Signed URL)
                const { data: storageData } = await supabase.storage
                    .from('protected-docs')
                    .createSignedUrl(PDF_FILENAME, 60);

                if (storageData) {
                    document.getElementById('pdf-link').href = storageData.signedUrl;
                }
            } else {
                document.getElementById('auth-ui').classList.remove('hidden');
                document.getElementById('dashboard').classList.add('hidden');
            }
            document.getElementById('loading').classList.add('hidden');
        }

        // Handle password reset redirections and auth state changes
        supabase.auth.onAuthStateChange(async (event, session) => {
            if (event === "PASSWORD_RECOVERY") {
                const newPassword = prompt("Please enter your new password:");
                if (newPassword) {
                    const { error } = await supabase.auth.updateUser({ password: newPassword });
                    if (error) alert("Error: " + error.message);
                    else alert("Password updated successfully!");
                }
            }
            refreshUI();
        });

        // Initial Load
        refreshUI();
    </script>
</body>
</html>
